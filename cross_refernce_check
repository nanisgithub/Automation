{% test cross_reference_lookup_check(model, source_columns, lookup_table, lookup_column, threshold, test_name) %}

WITH source_data AS (
    SELECT * FROM {{ model }}
),

error_data AS (
    SELECT *
    FROM {{ model }}
    WHERE
    (
        {% for col_expr in source_columns %}
            ({{ col_expr }} NOT IN (SELECT {{ lookup_column }} FROM {{ lookup_table }}))
            {% if not loop.last %}
                OR
            {% endif %}
        {% endfor %}
    )
)

-- same summary + logging logic as other macros...

{% endtest %}



- cross_reference_lookup_check:
    source_columns: ["REPLACE(DX1, '.', '')", "REPLACE(DX2, '.', '')"]
    lookup_table: "Contract.MSTR_ICD_Curr"
    lookup_column: "DiagnosisCode_NoDec"
    threshold: 5
    test_name: "DX1_DX2_Lookup_Check"