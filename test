CREATE TABLE dbo.DBT_NDC_Validation_RunLog (
    RunID INT IDENTITY(1,1) PRIMARY KEY,
    RunStartTime DATETIME,
    RunEndTime DATETIME,
    HealthPlan NVARCHAR(100),
    ProcessID NVARCHAR(100),
    ProfilingStatus NVARCHAR(50),
    ValidationStatus NVARCHAR(50),
    OverallStatus NVARCHAR(50),
    InsertedAt DATETIME DEFAULT GETDATE()
);




@echo off
setlocal enabledelayedexpansion

set /p healthplan=Enter HealthPlan: 
set /p processid=Enter ProcessID: 

REM Capture Start Time
set starttime=%date% %time%

REM Run DBT Profiling
dbt run --select tag:profiling --vars "{\"healthplan\": \"%healthplan%\", \"processid\": \"%processid%\"}"
if %errorlevel% neq 0 (
    set profiling_status=FAIL
) else (
    set profiling_status=SUCCESS
)

REM Run DBT Validations
dbt test --select tag:validation --vars "{\"healthplan\": \"%healthplan%\", \"processid\": \"%processid%\"}"
if %errorlevel% neq 0 (
    set validation_status=FAIL
) else (
    set validation_status=SUCCESS
)

REM Capture End Time
set endtime=%date% %time%

REM Calculate Overall Status
if "%profiling_status%"=="SUCCESS" if "%validation_status%"=="SUCCESS" (
    set overall_status=SUCCESS
) else (
    set overall_status=FAIL
)

REM Insert into SQL Server Log Table using Windows Authentication (-E flag)

sqlcmd -S YourServerName -d YourDatabaseName -E -Q "INSERT INTO dbo.DBT_NDC_Validation_RunLog (RunStartTime, RunEndTime, HealthPlan, ProcessID, ProfilingStatus, ValidationStatus, OverallStatus) VALUES (CAST('%starttime%' AS DATETIME), CAST('%endtime%' AS DATETIME), '%healthplan%', '%processid%', '%profiling_status%', '%validation_status%', '%overall_status%')"

pause